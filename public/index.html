
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kiro Token Tools</title>
  <style>
    /* CSS å˜é‡ - æ·±è‰²ä¸»é¢˜ï¼ˆé»˜è®¤ï¼‰ */
    :root {
      --bg-gradient-start: #1a1a2e;
      --bg-gradient-end: #16213e;
      --text-primary: #e4e4e7;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --accent-primary: #a78bfa;
      --accent-hover: #6d28d9;
      --accent-disabled: #4c1d95;
      --card-bg: rgba(255, 255, 255, 0.05);
      --card-border: rgba(255, 255, 255, 0.1);
      --input-bg: rgba(0, 0, 0, 0.3);
      --input-border: rgba(255, 255, 255, 0.1);
      --result-bg: rgba(0, 0, 0, 0.2);
      --result-border: rgba(255, 255, 255, 0.08);
      --usage-item-bg: rgba(255, 255, 255, 0.03);
      --token-output-bg: rgba(0, 0, 0, 0.4);
      --copy-btn-bg: rgba(124, 58, 237, 0.3);
      --copy-btn-border: rgba(124, 58, 237, 0.5);
      --copy-btn-text: #c4b5fd;
      --download-btn-bg: rgba(74, 222, 128, 0.3);
      --download-btn-border: rgba(74, 222, 128, 0.5);
      --download-btn-text: #86efac;
      --notice-bg: rgba(74, 222, 128, 0.1);
      --notice-border: rgba(74, 222, 128, 0.2);
      --notice-text: #86efac;
      --error-text: #f87171;
      --error-bg: rgba(248, 113, 113, 0.1);
      --hint-bg: rgba(74, 222, 128, 0.1);
      --hint-border: rgba(74, 222, 128, 0.3);
      --hint-text: #d4d4d8;
      --code-bg: rgba(0, 0, 0, 0.3);
      --code-text: #4ade80;
      --placeholder-text: #52525b;
      --loading-border: rgba(255, 255, 255, 0.3);
      --loading-top: white;
    }
    
    /* æµ…è‰²ä¸»é¢˜ */
    [data-theme="light"] {
      --bg-gradient-start: #f8fafc;
      --bg-gradient-end: #e2e8f0;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --accent-primary: #7c3aed;
      --accent-hover: #5b21b6;
      --accent-disabled: #c4b5fd;
      --card-bg: rgba(255, 255, 255, 0.8);
      --card-border: rgba(0, 0, 0, 0.1);
      --input-bg: rgba(255, 255, 255, 0.9);
      --input-border: rgba(0, 0, 0, 0.15);
      --result-bg: rgba(255, 255, 255, 0.6);
      --result-border: rgba(0, 0, 0, 0.08);
      --usage-item-bg: rgba(0, 0, 0, 0.03);
      --token-output-bg: rgba(0, 0, 0, 0.05);
      --copy-btn-bg: rgba(124, 58, 237, 0.15);
      --copy-btn-border: rgba(124, 58, 237, 0.4);
      --copy-btn-text: #7c3aed;
      --download-btn-bg: rgba(22, 163, 74, 0.15);
      --download-btn-border: rgba(22, 163, 74, 0.4);
      --download-btn-text: #16a34a;
      --notice-bg: rgba(22, 163, 74, 0.1);
      --notice-border: rgba(22, 163, 74, 0.3);
      --notice-text: #16a34a;
      --error-text: #dc2626;
      --error-bg: rgba(220, 38, 38, 0.1);
      --hint-bg: rgba(22, 163, 74, 0.08);
      --hint-border: rgba(22, 163, 74, 0.25);
      --hint-text: #334155;
      --code-bg: rgba(0, 0, 0, 0.08);
      --code-text: #16a34a;
      --placeholder-text: #94a3b8;
      --loading-border: rgba(0, 0, 0, 0.2);
      --loading-top: #7c3aed;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      min-height: 100vh;
      color: var(--text-primary);
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }
    .container { max-width: 900px; margin: 0 auto; }
    .header { display: flex; justify-content: center; align-items: center; position: relative; margin-bottom: 8px; }
    h1 { text-align: center; color: var(--accent-primary); font-size: 1.8rem; }
    .theme-select {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.8rem;
      color: var(--text-primary);
      transition: all 0.2s;
      outline: none;
    }
    .theme-select:hover { background: var(--input-bg); }
    .theme-select:focus { border-color: var(--accent-primary); }
    .subtitle { text-align: center; color: var(--text-muted); margin-bottom: 12px; font-size: 0.9rem; }
    .notice {
      text-align: center;
      color: var(--notice-text);
      background: var(--notice-bg);
      border: 1px solid var(--notice-border);
      border-radius: 8px;
      padding: 10px 16px;
      margin-bottom: 24px;
      font-size: 0.85rem;
    }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      transition: background 0.3s, border-color 0.3s;
    }
    .card-title { font-size: 1rem; color: var(--accent-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 0.85rem; }
    textarea {
      width: 100%;
      min-height: 180px;
      padding: 12px;
      border: 1px solid var(--input-border);
      border-radius: 8px;
      background: var(--input-bg);
      color: var(--text-primary);
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.8rem;
      resize: vertical;
      transition: background 0.3s, border-color 0.3s, color 0.3s;
    }
    textarea:focus { outline: none; border-color: var(--accent-primary); }
    textarea::placeholder { color: var(--placeholder-text); }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary { background: #7c3aed; color: white; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-primary:disabled { background: var(--accent-disabled); cursor: not-allowed; opacity: 0.6; }
    .btn-group { display: flex; gap: 10px; margin-top: 16px; }
    .result-section { display: none; }
    .result-section.show { display: block; }
    .result-item {
      background: var(--result-bg);
      border: 1px solid var(--result-border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      transition: background 0.3s, border-color 0.3s;
    }
    .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .result-title { font-weight: 500; color: var(--accent-primary); }
    .usage-info { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px; }
    .usage-item { text-align: center; padding: 10px; background: var(--usage-item-bg); border-radius: 6px; }
    .usage-value { font-size: 1.4rem; font-weight: 600; color: var(--accent-primary); }
    .usage-label { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
    .token-section { display: flex; gap: 12px; align-items: flex-start; }
    .token-output {
      flex: 1;
      background: var(--token-output-bg);
      border-radius: 6px;
      padding: 12px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.75rem;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 200px;
      overflow-y: auto;
      transition: background 0.3s;
    }
    .copy-btn {
      padding: 8px 12px;
      font-size: 0.75rem;
      background: var(--copy-btn-bg);
      border: 1px solid var(--copy-btn-border);
      color: var(--copy-btn-text);
      border-radius: 4px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }
    .copy-btn:hover { opacity: 0.8; }
    .download-btn {
      padding: 8px 12px;
      font-size: 0.75rem;
      background: var(--download-btn-bg);
      border: 1px solid var(--download-btn-border);
      color: var(--download-btn-text);
      border-radius: 4px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }
    .download-btn:hover { opacity: 0.8; }
    .btn-row { display: flex; gap: 8px; flex-direction: column; }
    .error { color: var(--error-text); background: var(--error-bg); padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; }
    .path-hint {
      margin-top: 12px;
      padding: 14px;
      background: var(--hint-bg);
      border: 1px solid var(--hint-border);
      border-radius: 6px;
      font-size: 0.8rem;
      color: var(--hint-text);
      transition: background 0.3s, border-color 0.3s;
    }
    .path-hint code {
      background: var(--code-bg);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      color: var(--code-text);
      font-size: 0.75rem;
    }
    .hint-title { color: var(--notice-text); font-weight: 500; margin-bottom: 10px; }
    .hint-section { margin-bottom: 12px; }
    .hint-section:last-child { margin-bottom: 0; }
    .hint-section strong { color: var(--accent-primary); display: block; margin-bottom: 6px; }
    .hint-section ol { margin: 0; padding-left: 20px; }
    .hint-section li { margin-bottom: 4px; line-height: 1.5; }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--loading-border);
      border-top-color: var(--loading-top);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .email-tag { 
      font-size: 0.75rem; 
      color: var(--notice-text); 
      background: var(--notice-bg);
      border: 1px solid var(--notice-border);
      padding: 2px 8px;
      border-radius: 4px;
      margin-left: 8px; 
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ”§ Kiro Token Tools</h1>
      <select class="theme-select" id="themeSelect" onchange="setTheme(this.value)" title="é€‰æ‹©ä¸»é¢˜">
        <option value="auto">ğŸ”„ è·Ÿéšç³»ç»Ÿ</option>
        <option value="light">â˜€ï¸ æµ…è‰²</option>
        <option value="dark">ğŸŒ™ æ·±è‰²</option>
      </select>
    </div>
    <p class="subtitle">ç”¨é‡æŸ¥è¯¢ & Token è½¬æ¢</p>
    <div class="notice">
      ğŸ”’ æœ¬å·¥å…·åŸºäº Cloudflare Workers è¿è¡Œï¼Œç›´æ¥è°ƒç”¨å®˜æ–¹æ¥å£ï¼ŒæœåŠ¡ç«¯ä¸å­˜å‚¨ä»»ä½•æ•°æ®ï¼Œè¯·æ”¾å¿ƒä½¿ç”¨ã€‚
    </div>
    
    <div class="card">
      <div class="card-title">ğŸ“¥ è¾“å…¥ Token æ•°æ®</div>
      <label>æ”¯æŒä»¥ä¸‹æ ¼å¼ï¼Œç›´æ¥ç²˜è´´å³å¯è‡ªåŠ¨è¯†åˆ«ï¼š</label>
      <textarea id="input" placeholder='ã€Social è´¦å· (Google/GitHub)ã€‘
{ "refreshToken": "xxx", "provider": "Google" }

ã€BuilderId/Enterprise è´¦å·ã€‘éœ€è¦ clientId å’Œ clientSecret:
{ "refreshToken": "xxx", "clientId": "xxx", "clientSecret": "xxx", "provider": "BuilderId", "region": "us-east-1" }

ã€å…¶ä»–æ ¼å¼ã€‘
è´¦å·ï¼š{"email":"xxx"}ç™»å½•tokenï¼š{"refreshToken":"xxx"}
{"email":"xxx"}|{"refreshToken":"xxx"}'></textarea>
      <div class="btn-group">
        <button class="btn btn-primary" id="submitBtn" onclick="processTokens()">
          <span id="btnText">ğŸš€ æŸ¥è¯¢ç”¨é‡ & è½¬æ¢</span>
          <span id="btnLoading" class="loading" style="display:none"></span>
        </button>
      </div>
    </div>
    
    <div class="result-section" id="resultSection">
      <div class="card">
        <div class="card-title">ğŸ“Š æŸ¥è¯¢ç»“æœ</div>
        <div id="results"></div>
      </div>
    </div>
  </div>

  <script>
    // ä¸»é¢˜ç®¡ç†ï¼šauto=è·Ÿéšç³»ç»Ÿ, light=æµ…è‰², dark=æ·±è‰²
    function getSystemTheme() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    
    // åº”ç”¨ä¸»é¢˜
    function applyTheme(theme) {
      const actualTheme = theme === 'auto' ? getSystemTheme() : theme;
      document.documentElement.setAttribute('data-theme', actualTheme);
    }
    
    // å®‰å…¨çš„ localStorage æ“ä½œ
    function safeGetItem(key, defaultValue = null) {
      try {
        return localStorage.getItem(key) || defaultValue;
      } catch (e) {
        console.warn('localStorage access denied:', e);
        return defaultValue;
      }
    }
    
    function safeSetItem(key, value) {
      try {
        localStorage.setItem(key, value);
        return true;
      } catch (e) {
        console.warn('localStorage write denied:', e);
        return false;
      }
    }
    
    // è®¾ç½®ä¸»é¢˜ï¼ˆç”¨æˆ·é€‰æ‹©ï¼‰
    function setTheme(theme) {
      safeSetItem('theme', theme);
      applyTheme(theme);
    }
    
    // åˆå§‹åŒ–ä¸»é¢˜
    (function initTheme() {
      const saved = safeGetItem('theme', 'auto');
      applyTheme(saved);
      // æ›´æ–°ä¸‹æ‹‰æ¡†é€‰ä¸­çŠ¶æ€
      const select = document.getElementById('themeSelect');
      if (select) select.value = saved;
      // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–ï¼ˆä»… auto æ¨¡å¼ç”Ÿæ•ˆï¼‰
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        if (safeGetItem('theme', 'auto') === 'auto') {
          applyTheme('auto');
        }
      });
    })();
    
    async function processTokens() {
      const input = document.getElementById('input').value.trim();
      if (!input) return;
      
      const btn = document.getElementById('submitBtn');
      const btnText = document.getElementById('btnText');
      const btnLoading = document.getElementById('btnLoading');
      const resultSection = document.getElementById('resultSection');
      const results = document.getElementById('results');
      
      btn.disabled = true;
      btnText.textContent = 'å¤„ç†ä¸­...';
      btnLoading.style.display = 'inline-block';
      
      try {
        const response = await fetch('/api/process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ input })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
        }
        
        resultSection.classList.add('show');
        
        if (data.error) {
          results.innerHTML = `<div class="error">âŒ ${data.error}</div>`;
          return;
        }
        
        const usage = data.usage;
        const kiroToken = data.kiroToken;
        const tokenJson = JSON.stringify(kiroToken, null, 2);
        const isBuilderIdType = data.isBuilderIdType;
        const clientIdHashFile = data.clientIdHashFile;
        
        // æ ¹æ® Token ç±»å‹ç”Ÿæˆä¸åŒçš„ä¿å­˜æ­¥éª¤
        let saveStepsHtml = '';
        if (isBuilderIdType && clientIdHashFile) {
          // BuilderId ç±»å‹ï¼šéœ€è¦ä¿å­˜ä¸¤ä¸ªæ–‡ä»¶
          const clientIdHashJson = JSON.stringify(clientIdHashFile.content, null, 2);
          saveStepsHtml = `
            <div class="path-hint">
              <div class="hint-title" style="display: flex; justify-content: space-between; align-items: center;">
                <span>ğŸ“ BuilderId è´¦å·ï¼ˆéœ€è¦ä¿å­˜ 2 ä¸ªæ–‡ä»¶ï¼‰</span>
                <div style="display: flex; gap: 8px;">
                  <button class="download-btn" onclick="downloadAllFiles(this)" style="font-size: 0.8rem; padding: 6px 16px;">â¬‡ï¸ ä¸€é”®ä¸‹è½½å…¨éƒ¨</button>
                  <button class="download-btn" onclick="downloadWindowsScript(this)" style="font-size: 0.8rem; padding: 6px 16px; background: rgba(59,130,246,0.3); border-color: rgba(59,130,246,0.5); color: #93c5fd;">âš¡ Winä¸€é”®æ›¿æ¢</button>
                </div>
              </div>
              
              <div class="hint-section" style="margin-top: 12px;">
                <strong>ğŸ“„ æ–‡ä»¶ 1ï¼škiro-auth-token.json</strong>
                <div class="token-section" style="margin: 8px 0;">
                  <div class="token-output" id="token-output">${tokenJson}</div>
                  <div class="btn-row">
                    <button class="copy-btn" onclick="copyToken(this, 'token-output')">ğŸ“‹ å¤åˆ¶</button>
                    <button class="download-btn" onclick="downloadTokenFile(this)">â¬‡ï¸ ä¸‹è½½</button>
                  </div>
                </div>
              </div>
              
              <div class="hint-section" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                <strong>ğŸ“„ æ–‡ä»¶ 2ï¼š${clientIdHashFile.filename}</strong>
                <p style="color: #a1a1aa; font-size: 0.75rem; margin: 4px 0 8px 0;">åŒ…å« clientId å’Œ clientSecretï¼Œç”¨äº Token åˆ·æ–°</p>
                <div class="token-section" style="margin: 8px 0;">
                  <div class="token-output" id="clientid-output">${clientIdHashJson}</div>
                  <div class="btn-row">
                    <button class="copy-btn" onclick="copyToken(this, 'clientid-output')">ğŸ“‹ å¤åˆ¶</button>
                    <button class="download-btn" onclick="downloadClientIdFile(this)">â¬‡ï¸ ä¸‹è½½</button>
                  </div>
                </div>
              </div>
              
              <div class="hint-section" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(251,191,36,0.1); padding: 12px; border-radius: 6px;">
                <strong style="color: #fbbf24;">ğŸ“ æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼š</strong>
                <ul style="margin: 8px 0 0 0; padding-left: 20px; list-style: disc;">
                  <li><b>macOS / Linuxï¼š</b><code>~/.aws/sso/cache/</code><br><span style="color: #a1a1aa; font-size: 0.7rem;">å¦‚ç›®å½•ä¸å­˜åœ¨ï¼š<code>mkdir -p ~/.aws/sso/cache</code></span></li>
                  <li><b>Windowsï¼š</b><code>C:\\Users\\ç”¨æˆ·å\\.aws\\sso\\cache\\</code><br><span style="color: #a1a1aa; font-size: 0.7rem;">å¦‚ç›®å½•ä¸å­˜åœ¨ï¼š<code>mkdir %USERPROFILE%\\.aws\\sso\\cache</code></span></li>
                </ul>
                <p style="margin-top: 8px; color: #a1a1aa; font-size: 0.75rem;">
                  ä¸‹è½½åå°†ä¸¤ä¸ªæ–‡ä»¶ç§»åŠ¨åˆ°ä¸Šè¿°ç›®å½•å³å¯ã€‚
                </p>
                <p style="margin-top: 6px; color: #fbbf24; font-size: 0.75rem;">
                  âš ï¸ æ³¨æ„ï¼šè¯·ç¡®ä¿ Kiro å®‰è£…åœ¨é»˜è®¤ç›®å½•ï¼Œå¦åˆ™éœ€è¦å°†æ–‡ä»¶æ”¾åˆ° Kiro å®é™…å®‰è£…ç›®å½•å¯¹åº”çš„ .aws/sso/cache ä¸‹ã€‚
                </p>
              </div>
            </div>
          `;
        } else {
          // Social ç±»å‹ï¼šåªéœ€ä¿å­˜ä¸€ä¸ªæ–‡ä»¶
          saveStepsHtml = `
            <div class="path-hint">
              <div class="hint-title">ğŸ“ Social è´¦å·ï¼ˆä¿å­˜ 1 ä¸ªæ–‡ä»¶ï¼‰</div>
              
              <div class="hint-section" style="margin-top: 8px;">
                <strong>ğŸ“„ æ–‡ä»¶ï¼škiro-auth-token.json</strong>
                <div class="token-section" style="margin: 8px 0;">
                  <div class="token-output" id="token-output">${tokenJson}</div>
                  <div class="btn-row">
                    <button class="copy-btn" onclick="copyToken(this, 'token-output')">ğŸ“‹ å¤åˆ¶</button>
                    <button class="download-btn" onclick="downloadTokenFile(this)">â¬‡ï¸ ä¸‹è½½</button>
                    <button class="download-btn" onclick="downloadWindowsScript(this)" style="background: rgba(59,130,246,0.3); border-color: rgba(59,130,246,0.5); color: #93c5fd;">âš¡ Winä¸€é”®æ›¿æ¢</button>
                  </div>
                </div>
              </div>
              
              <div class="hint-section" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(74,222,128,0.1); padding: 12px; border-radius: 6px;">
                <strong style="color: #4ade80;">ğŸ“ æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼š</strong>
                <ul style="margin: 8px 0 0 0; padding-left: 20px; list-style: disc;">
                  <li><b>macOS / Linuxï¼š</b><code>~/.aws/sso/cache/kiro-auth-token.json</code><br><span style="color: #a1a1aa; font-size: 0.7rem;">å¦‚ç›®å½•ä¸å­˜åœ¨ï¼š<code>mkdir -p ~/.aws/sso/cache</code></span></li>
                  <li><b>Windowsï¼š</b><code>C:\\Users\\ç”¨æˆ·å\\.aws\\sso\\cache\\kiro-auth-token.json</code><br><span style="color: #a1a1aa; font-size: 0.7rem;">å¦‚ç›®å½•ä¸å­˜åœ¨ï¼š<code>mkdir %USERPROFILE%\\.aws\\sso\\cache</code></span></li>
                </ul>
                <p style="margin-top: 8px; color: #a1a1aa; font-size: 0.75rem;">
                  ä¸‹è½½åå°†æ–‡ä»¶ç§»åŠ¨åˆ°ä¸Šè¿°è·¯å¾„å³å¯ã€‚
                </p>
                <p style="margin-top: 6px; color: #4ade80; font-size: 0.75rem;">
                  âš ï¸ æ³¨æ„ï¼šè¯·ç¡®ä¿ Kiro å®‰è£…åœ¨é»˜è®¤ç›®å½•ï¼Œå¦åˆ™éœ€è¦å°†æ–‡ä»¶æ”¾åˆ° Kiro å®é™…å®‰è£…ç›®å½•å¯¹åº”çš„ .aws/sso/cache ä¸‹ã€‚
                </p>
              </div>
            </div>
          `;
        }
        
        results.innerHTML = `
          <div class="result-item">
            <div class="result-header">
              <span class="result-title">æŸ¥è¯¢ç»“æœ <span style="font-size: 0.75rem; color: ${isBuilderIdType ? '#fbbf24' : '#4ade80'}; background: ${isBuilderIdType ? 'rgba(251,191,36,0.15)' : 'rgba(74,222,128,0.15)'}; padding: 2px 8px; border-radius: 4px; margin-left: 8px;">${isBuilderIdType ? 'BuilderId' : 'Social'}</span>${usage?.email ? '<span class="email-tag">' + usage.email + '</span>' : ''}</span>
            </div>
            ${usage ? `
              <div class="usage-info">
                <div class="usage-item">
                  <div class="usage-value">${usage.limit}</div>
                  <div class="usage-label">æ€»é™é¢</div>
                </div>
                <div class="usage-item">
                  <div class="usage-value">${usage.used}</div>
                  <div class="usage-label">å·²ä½¿ç”¨</div>
                </div>
                <div class="usage-item">
                  <div class="usage-value" style="color: ${usage.remaining > 0 ? '#4ade80' : '#f87171'}">${usage.remaining}</div>
                  <div class="usage-label">å‰©ä½™</div>
                </div>
              </div>
            ` : '<div class="error">âš ï¸ ç”¨é‡æŸ¥è¯¢å¤±è´¥ï¼ˆå¯èƒ½ accessToken å·²è¿‡æœŸï¼‰</div>'}
            ${saveStepsHtml}
          </div>
        `;
        
        window.tokenData = data;
        
      } catch (error) {
        resultSection.classList.add('show');
        results.innerHTML = `<div class="error">âŒ ${error.message}</div>`;
      } finally {
        btn.disabled = false;
        btnText.textContent = 'ğŸš€ æŸ¥è¯¢ç”¨é‡ & è½¬æ¢';
        btnLoading.style.display = 'none';
      }
    }
    
    function copyToken(btn, elementId) {
      const tokenEl = document.getElementById(elementId || 'token-output');
      navigator.clipboard.writeText(tokenEl.textContent).then(() => {
        btn.textContent = 'âœ… å·²å¤åˆ¶';
        setTimeout(() => btn.textContent = 'ğŸ“‹ å¤åˆ¶', 1500);
      });
    }
    
    // ä¸‹è½½å•ä¸ªæ–‡ä»¶
    function downloadFile(content, filename) {
      const blob = new Blob([content], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // ä¸‹è½½ kiro-auth-token.json
    function downloadTokenFile(btn) {
      if (!window.tokenData || !window.tokenData.kiroToken) return;
      const content = JSON.stringify(window.tokenData.kiroToken, null, 2);
      downloadFile(content, 'kiro-auth-token.json');
      btn.textContent = 'âœ… å·²ä¸‹è½½';
      setTimeout(() => btn.textContent = 'â¬‡ï¸ ä¸‹è½½', 1500);
    }
    
    // ä¸‹è½½ clientIdHash æ–‡ä»¶
    function downloadClientIdFile(btn) {
      if (!window.tokenData || !window.tokenData.clientIdHashFile) return;
      const file = window.tokenData.clientIdHashFile;
      const content = JSON.stringify(file.content, null, 2);
      downloadFile(content, file.filename);
      btn.textContent = 'âœ… å·²ä¸‹è½½';
      setTimeout(() => btn.textContent = 'â¬‡ï¸ ä¸‹è½½', 1500);
    }
    
    // ä¸€é”®ä¸‹è½½æ‰€æœ‰æ–‡ä»¶ï¼ˆBuilderId ç±»å‹ï¼‰
    function downloadAllFiles(btn) {
      if (!window.tokenData) return;
      // ä¸‹è½½ kiro-auth-token.json
      const tokenContent = JSON.stringify(window.tokenData.kiroToken, null, 2);
      downloadFile(tokenContent, 'kiro-auth-token.json');
      // å¦‚æœæœ‰ clientIdHash æ–‡ä»¶ä¹Ÿä¸‹è½½
      if (window.tokenData.clientIdHashFile) {
        setTimeout(() => {
          const file = window.tokenData.clientIdHashFile;
          const content = JSON.stringify(file.content, null, 2);
          downloadFile(content, file.filename);
        }, 300);
      }
      btn.textContent = 'âœ… å·²ä¸‹è½½';
      setTimeout(() => btn.textContent = 'â¬‡ï¸ ä¸€é”®ä¸‹è½½å…¨éƒ¨', 1500);
    }
    
    // ç”Ÿæˆ Windows ä¸€é”®æ›¿æ¢è„šæœ¬
    function generateWindowsScript() {
      if (!window.tokenData || !window.tokenData.kiroToken) return null;
      
      const token = window.tokenData.kiroToken;
      // ä½¿ç”¨ Base64 ç¼–ç  JSONï¼Œé¿å…å¼•å·è½¬ä¹‰é—®é¢˜ï¼ˆå¸¦ç¼©è¿›æ ¼å¼ï¼‰
      const tokenJsonStr = JSON.stringify(token, null, 2);
      const tokenBase64 = btoa(unescape(encodeURIComponent(tokenJsonStr)));
      
      // ç”Ÿæˆæ—¶é—´æˆ³
      const now = new Date();
      const timestamp = now.getFullYear().toString() +
        (now.getMonth() + 1).toString().padStart(2, '0') +
        now.getDate().toString().padStart(2, '0') + '_' +
        now.getHours().toString().padStart(2, '0') +
        now.getMinutes().toString().padStart(2, '0') +
        now.getSeconds().toString().padStart(2, '0');
      
      // å¦‚æœæ˜¯ BuilderId ç±»å‹ï¼Œè¿˜éœ€è¦å¤„ç† clientIdHash æ–‡ä»¶
      let clientIdScript = '';
      if (window.tokenData.isBuilderIdType && window.tokenData.clientIdHashFile) {
        const clientFile = window.tokenData.clientIdHashFile;
        const clientJsonStr = JSON.stringify(clientFile.content, null, 2);
        const clientBase64 = btoa(unescape(encodeURIComponent(clientJsonStr)));
        
        clientIdScript = `
set "CLIENTID_FILE=%KIRO_DIR%\\${clientFile.filename}"
echo [INFO] Writing clientIdHash file...
powershell -Command "$b64='${clientBase64}'; $bytes=[Convert]::FromBase64String($b64); $json=[Text.Encoding]::UTF8.GetString($bytes); [IO.File]::WriteAllText('%CLIENTID_FILE%', $json, (New-Object Text.UTF8Encoding $false))"
if errorlevel 1 (
    echo [ERROR] Failed to write clientIdHash file!
    pause
    exit /b 1
)
echo [OK] clientIdHash file written!
`;
      }
      
      const script = `@echo off
chcp 65001 >nul

echo ========================================
echo   Kiro Token Replace Tool
echo ========================================
echo.

set "KIRO_DIR=%USERPROFILE%\\.aws\\sso\\cache"
set "TOKEN_FILE=%KIRO_DIR%\\kiro-auth-token.json"
set "BACKUP_FILE=%TOKEN_FILE%.backup_${timestamp}"

echo [DEBUG] KIRO_DIR=%KIRO_DIR%
echo [DEBUG] TOKEN_FILE=%TOKEN_FILE%
echo.

if not exist "%KIRO_DIR%" (
    echo [INFO] Creating directory: %KIRO_DIR%
    mkdir "%KIRO_DIR%"
    if errorlevel 1 (
        echo [ERROR] Failed to create directory!
        pause
        exit /b 1
    )
    echo [OK] Directory created!
) else (
    echo [INFO] Directory exists: %KIRO_DIR%
)

if exist "%TOKEN_FILE%" (
    echo [INFO] Backing up original file...
    copy "%TOKEN_FILE%" "%BACKUP_FILE%" >nul
    if errorlevel 1 (
        echo [ERROR] Backup failed!
        pause
        exit /b 1
    )
    echo [OK] Backed up to: %BACKUP_FILE%
) else (
    echo [INFO] Original file not exist, skip backup
)

echo [INFO] Writing new Token...
powershell -Command "$b64='${tokenBase64}'; $bytes=[Convert]::FromBase64String($b64); $json=[Text.Encoding]::UTF8.GetString($bytes); [IO.File]::WriteAllText('%TOKEN_FILE%', $json, (New-Object Text.UTF8Encoding $false))"
if errorlevel 1 (
    echo [ERROR] Failed to write Token!
    pause
    exit /b 1
)
echo [OK] Token replaced!
${clientIdScript}
echo.
echo ========================================
echo   Done! Please restart Kiro
echo ========================================
echo.
pause
`;
      
      return script;
    }
    
    // ä¸‹è½½ Windows ä¸€é”®æ›¿æ¢è„šæœ¬
    function downloadWindowsScript(btn) {
      const script = generateWindowsScript();
      if (!script) return;
      
      const blob = new Blob([script], { type: 'application/bat' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'kiro-token-replace.bat';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      btn.textContent = 'âœ… å·²ä¸‹è½½';
      setTimeout(() => btn.textContent = 'âš¡ Winä¸€é”®æ›¿æ¢', 1500);
    }
  </script>
</body>
</html>